<html>

<head>

    <title>YMPI Produksi</title>
    <!-- <meta http-equiv="refresh" content="30"> -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <!-- JQuery -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/popper.min.js"></script>
    <!-- Bootstrap 4.1 -->
    <script src="assets/js/bootstrap.min.js"></script>
    <!-- FontAwesome -->
    <script src="assets/js/font-awesome.min.js" data-auto-replace-svg="nest"></script>
    <!-- FusionCharts -->
    <script src="assets/js/fusioncharts.js"></script>
    <script src="assets/js/jquery-fusioncharts.min.js"></script>
    <script src="assets/js/fusioncharts.theme.fusion.js"></script>
    <!-- Moment.js -->
    <script src="assets/js/moment.min.js"></script>
    <meta charset="utf-8" />
    <!-- <style type="text/css" media="screen">
    @keyframes marquee {
        0% {
            text-indent: 430px
        }
        100% {
            text-indent: -485px
        }
    }

    @-webkit-keyframes marquee {
        0% {
            text-indent: 430px
        }
        100% {
            text-indent: -485px
        }
    }

    .marquee {
        overflow: hidden;
        white-space: nowrap;
        animation: marquee 20s linear infinite;
        marquee-speed: fastest;
        -webkit-animation: marquee 20s linear infinite;
        -webkit-marquee-speed: fastest;
        width: 100%;
        background: #FFFF00;
    }

    .marquee:hover {
        -webkit-animation-play-state: paused;
        animation-play-state: paused;
    }
    </style> -->
</head>

<body>
            <!-- <div class="row justify-content-center align-items-center pt-5"> -->
            <div class="col-12">
                <a class="btn btn-default float-right" id="open-ws-1"><font color="0000FF"><font size="3"><b>Weekly Shipping Chart (週次出荷コンテナー別)</b></font></font><i class="fa fa-arrow-right"></i></a>
                <ul class="nav nav-pills pt-3" id="tab-chart-1"></ul>
                <!-- <div class="text-center">
                    <h5 id="chart-title-1" class="d-none"></h5>                    
                </div> -->
                <div id="chart-container-1" class="text-center tab-content pt-2"></div>
                <div class="text-right pt-3">
                    <button id="btn-close" class='btn btn-danger d-none'><i class="fas fa-arrow-left"></i> Back バック</button>
                </div>
            </div>
            <div class="col-12 d-none pt-3" id="chart-2">
                <a class="btn btn-default float-right" id="open-ws-2"><font color="0000FF"><font size="3"><b>Weekly Shipping Chart (週次出荷コンテナー別)</b></font></font><i class="fa fa-arrow-right"></i></a>
                <div class="text-center">
                    <h5 id="chart-title-2" class="d-none"></h5>
                </div>
                <div id="chart-container-2" class="text-center"></div>
            </div>
        </div>
        <!-- Modal -->
        <div id="modal" class="modal fade" role="dialog">
            <div class="modal-dialog modal-dialog-centered">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">
                            <h4 id="modal-title">Modal header will be here</h4>
                            <small>Tgl: <span id="table-tgl"></span></small>
                        </div>
                    </div>
                    <div class="modal-body" id="modal-content">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th scope="col">GMC</th>
                                    <th scope="col">Desc</th>
                                    <th scope="col">Plan</th>
                                    <th scope="col">Actual</th>
                                    <th scope="col">Diff +</th>
                                    <th scope="col">Diff -</th>
                                </tr>
                            </thead>
                            <tbody id="table-data"></tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2">Total</th>
                                    <th id="table-total-plan" class='text-right'></th>
                                    <th id="table-total-actual" class='text-right'></th>
                                    <th id="table-total-diff-plus" class='text-right'></th>
                                    <th id="table-total-diff-minus" class='text-right'></th>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="text-right pt-3">
                            <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fas fa-times"></i> Close 閉じる</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal WS -->
        <div id="modal-ws" class="modal fade" role="dialog">
            <div class="modal-dialog modal-dialog-centered">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">
                            <h4 id="modal-ws-title">Modal header will be here</h4>
                            <small><span id="table-ws-tgl"></span></small>
                        </div>
                    </div>
                    <div class="modal-body" id="modal-ws-content">
                        <table class="table table-ws-sm">
                            <thead>
                                <tr>
                                    <th scope="col">GMC</th>
                                    <th scope="col">Desc</th>
                                    <th scope="col">Plan</th>
                                    <th scope="col">Actual</th>
                                    <th scope="col">Diff</th>
                                </tr>
                            </thead>
                            <tbody id="table-ws-data"></tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2">Total</th>
                                    <th id="table-ws-total-plan" class='text-right'></th>
                                    <th id="table-ws-total-actual" class='text-right'></th>
                                    <th id="table-ws-total-diff" class='text-right'></th>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="text-right pt-3">
                            <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fas fa-times"></i> Tutup</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Error Modal -->
        <div id="modal-error" class="modal fade" role="dialog">
            <div class="modal-dialog modal-dialog-centered">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="alert alert-danger text-center" role="alert" id="error-msg">
                            Data kosong!
                        </div>
                        <div class="text-right pt-3">
                            <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fas fa-times"></i> Tutup</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="hidden-week" value="" />
    <input type="hidden" id="hidden-date" value="" />
    <input type="hidden" id="hidden-type" value="" />
    <!-- Main Script -->
    <script type="text/javascript" src="assets/js/main.js"></script>
    <script>
    // DOM event
    $(document).ready(function() {
        // Render main chart
        initiateData();

        // Button close
        $('#btn-close').click(function() {
            initiateData();
        });

        // Button WS
        $('#btn-ws').click(function() {
            var dType = $('#hidden-type').val();
            var dDate = $('#hidden-date').val();
            var dWeek = $('#hidden-week').val();

            // Set chart title
            $('#chart-title-1').html('Weekly Shipping Chart (週次出荷コンテナー別) - ETD YEMI based (工場出荷日の基準)');

            $.ajax({
                type: 'POST',
                url: 'api/postWs.php',
                dataType: "json",
                data: {
                    data_type: dType,
                    data_week: dWeek,
                    data_date: dDate
                },
                success: function(response) {
                    // hide WS button
                    $('#btn-ws').addClass('d-none');

                    // Function to get the latest date
                    function getLatestDate(data) {
                        var maxNumb = [];
                        for (var y = 0; y < data.data.length; y++) {
                            maxNumb.push(new Date(data.data[y].tanggal));
                        }
                        var latestDate = moment(new Date(Math.max.apply(null, maxNumb))).format('YYYY-MM-DD');
                        return latestDate;
                    }

                    // Populate dataset
                    var dataSet = [],
                        dataCat = [],
                        tempPlan = [],
                        tempAct = [];
                    var rawData = response.result;
                    var sortedData = sortWsData(rawData);

                    // Generate marquees
                    if (sortedData.length > 3) {
                        $('#text').html('YMPI');
                    } else {
                        $('#marquee-text').html('bla bla');
                    }

                    sortedData.forEach(function(dt) {
                        dataCat.push({
                            "label": dt.produk.toUpperCase()
                        });

                        var filteredData = [];
                        var theDate = getLatestDate(dt);
                        dt.data.forEach(function(x) {
                            if (x.tanggal == theDate) filteredData.push(x);
                        });

                        filteredData.forEach(function(y) {
                            tempPlan.push({ "value": y.target_persentase - y.persentase_shipment });
                            tempAct.push({ "value": y.persentase_shipment });
                        })
                    });

                    dataSet = [{
                        "seriesname": "Completed",
                        "color": "8A2BE2",
                        "data": tempAct
                    }, {
                        "seriesname": "In_Progress",
                        "color": "F0E68C",
                        "data": tempPlan
                    }];

                    // Render WS chart
                    $('#chart-container-1').insertFusionCharts({
                        type: 'scrollstackedcolumn2d',
                        width: 200,
                        height: 100,
                        dataFormat: 'json',
                        dataSource: {
                            "chart": {
                                "caption": "Weekly Shipping Chart (週次出荷コンテナー別) - ETD YMPI based (工場出荷日の基準)",
                                "captionFontSize": "25",
                                "subCaption": "Week " + dWeek,
                                "subcaptionFontSize": "20",
                                "subCaptionFontBold": "1",
                                "subCaptionFontColor": "008000",
                                "baseFont": "Meiryo",
                                // "baseFontSize": "15",
                                "xAxisName": "Produk",
                                "yAxisName": "Total Completion",
                                "theme": "fusion",
                                "stack100percent": "1",
                                "plotSpacePercent":"50",
                                "decimals": "1",
                                "plotFillAlpha": "80",
                                "divLineIsDashed": "1",
                                "divLineDashLen": "1",
                                "divLineGapLen": "5",
                                "showValues": "1",
                                "valueFontSize": "25",
                                "valueFontBold": "1",
                                "numberSuffix": "%",
                                "bgColor": "#DDDDDD",
                                "bgAlpha": "50",
                                "id": 'main-chart'
                            },
                            "categories": [{
                                "category": dataCat
                            }],
                            "dataset": dataSet
                        }
                    });
                },
                error: function(err) {
                    alert(JSON.stringify(err));
                }
            })
        });

        // Button WS Chart 1
        $('#open-ws-1').click(function() {
            // Unset chart title
            $('#chart-title-1').addClass('d-none');
            // Hide chart #2
            $('#chart-2').addClass('d-none');
            // hide tabs
            $('.nav').addClass('d-none');
            // hide/show related button
            $('#btn-close').removeClass('d-none');
            // hide WS button
            $('#open-ws-1').addClass('d-none');

            $.ajax({
                type: 'POST',
                url: 'api/postWsIndex.php',
                dataType: "json",
                data: {
                    data_type: "FL",
                    data_week: $('#hidden-week').val()
                },
                success: function(response) {
                    // Function to get the latest date
                    function getLatestDate(data) {
                        var maxNumb = [];
                        for (var y = 0; y < data.data.length; y++) {
                            maxNumb.push(new Date(data.data[y].tanggal));
                        }
                        var latestDate = moment(new Date(Math.max.apply(null, maxNumb))).format('YYYY-MM-DD');
                        return latestDate;
                    }

                    // Populate dataset
                    var dataSet = [],
                        dataCat = [],
                        totPlan = [],
                        totAct = [];
                    var rawData = response.result;
                    var sortedData = sortWsDataIndex(rawData);

                    sortedData.forEach(function(dt) {
                        dataCat.push({
                            "label": dt.tipe_produk.toUpperCase()
                        });

                        var d = dt.data;
                        var tempPlan = 0,
                            tempAct = 0;
                        d.forEach(function(val) {
                            tempPlan += parseInt(val.plan);
                            tempAct += parseInt(val.actual);
                        })

                        totPlan.push({ "value": tempPlan-tempAct })
                        totAct.push({ "value": tempAct });
                    });

                    dataSet = [{
                        "seriesname": "Completed",
                        "color": "483D8B",
                        "data": totAct
                    }, {
                        "seriesname": "Uncompleted",
                        "color": "F0E68C",
                        "data": totPlan
                    }];

                    // Render WS chart
                    $('#chart-container-1').insertFusionCharts({
                        type: 'scrollstackedcolumn2d',
                        width: 1230,
                        height: 530,
                        dataFormat: 'json',
                        dataSource: {
                            "chart": {
                                "caption": "Weekly Shipping Chart (週次出荷コンテナー別) - ETD YMPI based (工場出荷日の基準)",
                                "captionFontSize": "20",
                                "subCaption": "Week " + $('#hidden-week').val(),
                                "subcaptionFontSize": "20",
                                "subCaptionFontBold": "1",
                                "subCaptionFontColor": "008000",
                                "baseFont": "Meiryo",
                                // "baseFontSize": "15",
                                "xAxisName": "Produk",
                                "yAxisName": "Total Completion",
                                "theme": "fusion",
                                "stack100percent": "1",
                                "plotSpacePercent":"50",
                                //"decimals": "1",
                                "plotFillAlpha": "80",
                                "divLineIsDashed": "1",
                                "divLineDashLen": "1",
                                "divLineGapLen": "5",
                                "showValues": "1",
                                "valueFontSize": "20",
                                "valueFontBold": "1",
                                "numberSuffix": "%",
                                "bgColor": "#DDDDDD",
                                "bgAlpha": "50",
                                "id": 'main-chart'
                            },
                            "categories": [{
                                "category": dataCat
                            }],
                            "dataset": dataSet
                        },
                        "events": {
                            "dataPlotClick": function(eventObj, dataObj) {

                                $('#modal-ws-title').html('Kesesuaian Per Item 部品ごとの適合性: ' + dataObj.categoryLabel);
                                $("#table-ws-tgl").html("Minggu ke: " + $('#hidden-week').val());

                                // clear the table
                                $("#table-ws-data").html('');

                                var totPlan = 0,
                                    totAct = 0,
                                    totDiff = 0;

                                var cdata;
                                $.each(sortedData, function(key, val) {
                                    if (val.tipe_produk == dataObj.categoryLabel.toLowerCase()) {
                                        cdata = val.data;
                                        cdata.forEach(function(value) {
                                            // mencari diff dari actual dan plan
                                            var diff = parseInt(value.actual) - parseInt(value.plan);
                                            // jika diff tidak sama dengan nol, maka tampilkan
                                            if (diff != 0) var diffLabel = diff;
                                            // tapi jika diff = nol, maka jangan ditampilkan
                                            else var diffLabel = '';

                                            // jika diff tidak sama dgn nol, maka render element dan hitung total
                                             if (diff != 0) {
                                                $("#table-ws-data").append("<tr><td>" + value.gmc + "</td><td>" + value.description + "</td><td class='text-right'>" + value.plan + "</td><td class='text-right'>" + value.actual + "</td><td class='text-right'>" + diffLabel + "</td></tr>");

                                                totPlan += parseInt(value.plan);
                                                totAct += parseInt(value.actual);
                                            }
                                        })
                                    }
                                });

                                // Format the numbers
                                // totPlan = numberWithCommas(totPlan);
                                // totAct = numberWithCommas(totAct);
                                // totDiff = numberWithCommas(totDiff);

                                // append the Qty total
                                $('#table-ws-total-plan').html(totPlan);
                                $('#table-ws-total-actual').html(totAct);
                                // $('#table-ws-total-diff').html(totDiff);

                                // Show the MODAL
                                $('#modal-ws').modal('show');

                            }
                        }
                    });
                },
                error: function(err) {
                    alert(JSON.stringify(err));
                }
            })
        });

        // Button WS Chart 2
        $('#open-ws-2').click(function() {
            // Unset chart title
            $('#chart-title-1').addClass('d-none');
            // Hide chart #2
            $('#chart-2').addClass('d-none');
            // hide tabs
            $('.nav').addClass('d-none');
            // hide/show related button
            $('#btn-close').removeClass('d-none');
            // hide WS button
            $('#open-ws-1').addClass('d-none');

            $.ajax({
                type: 'POST',
                url: 'api/postWsIndex.php',
                dataType: "json",
                data: {
                    data_type: "PN",
                    data_week: $('#hidden-week').val()
                },
                success: function(response) {
                    // Function to get the latest date
                    function getLatestDate(data) {
                        var maxNumb = [];
                        for (var y = 0; y < data.data.length; y++) {
                            maxNumb.push(new Date(data.data[y].tanggal));
                        }
                        var latestDate = moment(new Date(Math.max.apply(null, maxNumb))).format('YYYY-MM-DD');
                        return latestDate;
                    }

                    // Populate dataset
                    var dataSet = [],
                        dataCat = [],
                        totPlan = [],
                        totAct = [];
                    var rawData = response.result;
                    var sortedData = sortWsDataIndex(rawData);

                    sortedData.forEach(function(dt) {
                        dataCat.push({
                            "label": dt.tipe_produk.toUpperCase()
                        });

                        var d = dt.data;
                        var tempPlan = 0,
                            tempAct = 0;
                        d.forEach(function(val) {
                            tempPlan += parseInt(val.plan);
                            tempAct += parseInt(val.actual);
                        })

                        totPlan.push({ "value": tempPlan-tempPlan })
                        totAct.push({ "value": tempAct });
                    });

                    dataSet = [{
                        "seriesname": "Completed",
                        "color": "483D8B",
                        "data": totAct
                    }, {
                        "seriesname": "Uncompleted",
                        "color": "F0E68C",
                        "data": totPlan
                    }];

                    // Render WS chart EDIN
                    $('#chart-container-1').insertFusionCharts({
                        type: 'scrollstackedcolumn2d',
                        width: 1230,
                        height: 530,
                        dataFormat: 'json',
                        dataSource: {
                            "chart": {
                                "caption": "Weekly Shipping Chart (週次出荷コンテナー別) - ETD YMPI based (工場出荷日の基準)",
                                "captionFontSize": "20",
                                "subCaption": "Week " + $('#hidden-week').val(),
                                "subcaptionFontSize": "20",
                                "subCaptionFontBold": "1",
                                "subCaptionFontColor": "008000",
                                "baseFont": "Meiryo",
                                // "baseFontSize": "15",
                                "xAxisName": "Produk",
                                "yAxisName": "Total Completion",
                                "theme": "fusion",
                                "stack100percent": "1",
                                "plotSpacePercent":"50",
                                "decimals": "1",
                                "plotFillAlpha": "80",
                                "divLineIsDashed": "1",
                                "divLineDashLen": "1",
                                "divLineGapLen": "5",
                                "showValues": "1",
                                "valueFontSize": "20",
                                "valueFontBold": "1",
                                "numberSuffix": "%",
                                "bgColor": "#DDDDDD",
                                "bgAlpha": "50",
                                "id": 'main-chart'
                            },
                            "categories": [{
                                "category": dataCat
                            }],
                            "dataset": dataSet
                        },
                        "events": {
                            "dataPlotClick": function(eventObj, dataObj) {

                                $('#modal-ws-title').html('Kesesuaian Per Item 部品ごとの適合性: ' + dataObj.categoryLabel);
                                $("#table-ws-tgl").html("Minggu ke: " + $('#hidden-week').val());

                                // clear the table
                                $("#table-ws-data").html('');

                                var totPlan = 0,
                                    totAct = 0,
                                    totDiff = 0;

                                var cdata;
                                $.each(sortedData, function(key, val) {
                                    if (val.tipe_produk == dataObj.categoryLabel.toLowerCase()) {
                                        cdata = val.data;
                                        cdata.forEach(function(value) {
                                            // mencari diff dari actual dan plan
                                            var diff = parseInt(value.actual) - parseInt(value.plan);
                                            // jika diff tidak sama dengan nol, maka tampilkan
                                            if (diff != 0) var diffLabel = diff;
                                            // tapi jika diff = nol, maka jangan ditampilkan
                                            else var diffLabel = '';

                                            // jika diff tidak sama dgn nol, maka render element dan hitung total
                                            if (diff != 0) {
                                                $("#table-ws-data").append("<tr><td>" + value.gmc + "</td><td>" + value.description + "</td><td class='text-right'>" + value.plan + "</td><td class='text-right'>" + value.actual + "</td><td class='text-right'>" + diffLabel + "</td></tr>");

                                                totPlan += parseInt(value.plan);
                                                totAct += parseInt(value.actual);
                                            }
                                        })
                                    }
                                });

                                // Format the numbers
                                // totPlan = numberWithCommas(totPlan);
                                // totAct = numberWithCommas(totAct);
                                // totDiff = numberWithCommas(totDiff);

                                // append the Qty total
                                $('#table-ws-total-plan').html(totPlan);
                                $('#table-ws-total-actual').html(totAct);
                                // $('#table-ws-total-diff').html(totDiff);

                                // Show the MODAL
                                $('#modal-ws').modal('show');

                            }
                        }
                    });
                },
                error: function(err) {
                    alert(JSON.stringify(err));
                }
            })
        });
    });
    </script>
</body>

</html>
