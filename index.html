<html>

<head>
    <title>YMPI Produksi</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <!-- JQuery -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/popper.min.js"></script>
    <!-- Bootstrap 4.1 -->
    <script src="assets/js/bootstrap.min.js"></script>
    <!-- FontAwesome -->
    <script src="assets/js/font-awesome.min.js" data-auto-replace-svg="nest"></script>
    <!-- FusionCharts -->
    <script src="assets/js/fusioncharts.js"></script>
    <script src="assets/js/jquery-fusioncharts.min.js"></script>
    <script src="assets/js/fusioncharts.theme.fusion.js"></script>
    <!-- Moment.js -->
    <script src="assets/js/moment.min.js"></script>
    <style type="text/css" media="screen">
    @keyframes marquee {
        0% {
            text-indent: 430px
        }
        100% {
            text-indent: -485px
        }
    }

    @-webkit-keyframes marquee {
        0% {
            text-indent: 430px
        }
        100% {
            text-indent: -485px
        }
    }

    .marquee {
        overflow: hidden;
        white-space: nowrap;
        animation: marquee 20s linear infinite;
        marquee-speed: fast;
        -webkit-animation: marquee 20s linear infinite;
        -webkit-marquee-speed: fast;
        width: 100%;
        background: #FFC300;
    }

    .marquee:hover {
        -webkit-animation-play-state: paused;
        animation-play-state: paused;
    }
    </style>
</head>

<body>
    <div class="container h-100">
        <div class="row h-100 justify-content-center align-items-center">
            <div class="col-12">
                <div class="text-center">
                    <h5 id="title-chart-1">Perolehan Produksi (FL, CL, AS, TS)</h5>
                    <div class="pt-1 pb-1 marquee">
                        <!-- <marquee> -->
                        <span style="font-family: Impact; font-size: 18pt">Lorem ipsum dolor Lorem ipsum dolor Lorem ipsum dolor Lorem ipsum dolor Lorem ipsum dolor Lorem ipsum dolor!</span>
                        <!-- </marquee> -->
                    </div>
                </div>
                <div id="chart-container-1" class="text-center">Chart #1 will load here!</div>
                <div class="text-right">
                    <button id="btn-close" class='btn btn-danger d-none'><i class="fas fa-arrow-left"></i> Kembali</button>
                    <button id="btn-ws" class="btn btn-success d-none">Weekly Shipment <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            <div class="col-12 d-none" id="chart-2">
                <div class="text-center">
                    <h5 id="title-chart-2">Perolehan Produksi (PN, RC, VN)</h5>
                    <div class="pt-1 pb-1 marquee">
                        <!-- <marquee> -->
                        <span style="font-family: Impact; font-size: 18pt">Lorem ipsum dolor Lorem ipsum dolor Lorem ipsum dolor Lorem ipsum dolor Lorem ipsum dolor Lorem ipsum dolor!</span>
                        <!-- </marquee> -->
                    </div>
                </div>
                <div id="chart-container-2" class="text-center">Chart #2 will load here!</div>
            </div>
        </div>
        <!-- Modal -->
        <div id="modal" class="modal fade" role="dialog">
            <div class="modal-dialog modal-dialog-centered">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">
                            <h4 id="modal-title">Modal header will be here</h4>
                            <small>Tgl: <span id="table-tgl"></span></small>
                        </div>
                    </div>
                    <div class="modal-body" id="modal-content">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th scope="col">GMC</th>
                                    <th scope="col">Desc</th>
                                    <th scope="col">Plan</th>
                                    <th scope="col">Actual</th>
                                    <th scope="col">Diff</th>
                                </tr>
                            </thead>
                            <tbody id="table-data"></tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2">Total</th>
                                    <th id="table-total-plan"></th>
                                    <th id="table-total-actual"></th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="text-right pt-3">
                            <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fas fa-times"></i> Tutup</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Error Modal -->
        <div id="modal-error" class="modal fade" role="dialog">
            <div class="modal-dialog modal-dialog-centered">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="alert alert-danger text-center" role="alert" id="error-msg">
                            Data kosong!
                        </div>
                        <div class="text-right pt-3">
                            <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fas fa-times"></i> Tutup</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="hidden-date" value="" />
    <input type="hidden" id="hidden-type" value="" />
    <!-- Main Script -->
    <script>
    // Function for rendering main chart
    var renderMainChart = function(data) {
        // hide buttons
        $('#btn-close, #btn-ws').addClass('d-none');

        // Un-hide chart #2 container
        $('#chart-2').removeClass('d-none');

        // Chart #1
        $('#chart-container-1').insertFusionCharts({
            type: 'mscolumn3d',
            width: 1024,
            height: 300,
            dataFormat: 'json',
            dataSource: {
                "chart": {
                    "labelDisplay": "Auto",
                    "yAxisName": "Perolehan",
                    "theme": "fusion",
                    "plotFillAlpha": "80",
                    "divLineIsDashed": "1",
                    "divLineDashLen": "1",
                    "divLineGapLen": "1",
                    "showValues": "1",
                    "id": 'main-chart'
                },
                "categories": [{
                    "category": data.categories
                }],
                "dataset": [{
                        "seriesname": "Plan",
                        "data": data.plan
                    },
                    {
                        "seriesname": "Actual",
                        "data": data.actual
                    }
                ]
            },
            "events": {
                "dataPlotClick": function(eventObj, dataObj) {
                    var finalData = {}
                    $.ajax({
                        type: 'POST',
                        url: 'api/postData.php',
                        dataType: "json",
                        data: {
                            tanggal: moment(dataObj.categoryLabel).format('YYYY-MM-DD')
                        },
                        success: function(res) {
                            var rawObj = res.result;

                            // Find each product's diff
                            var flDiffPlus = 0,
                                flDiffMin = 0,
                                clDiffPlus = 0,
                                clDiffMin = 0,
                                asDiffPlus = 0,
                                asDiffMin = 0,
                                tsDiffPlus = 0,
                                tsDiffMin = 0;

                            rawObj.forEach(function(dt) {
                                if (dt.tipe_produk == 'fl') {
                                    var flCalc = dt.actual - dt.plan;
                                    if (flCalc > 0) flDiffPlus += flCalc;
                                    else flDiffMin += flCalc;
                                }

                                if (dt.tipe_produk == 'cl') {
                                    var clCalc = dt.actual - dt.plan;
                                    if (clCalc > 0) clDiffPlus += clCalc;
                                    else clDiffMin += clCalc;
                                }

                                if (dt.tipe_produk == 'as') {
                                    var asCalc = dt.actual - dt.plan;
                                    if (asCalc > 0) asDiffPlus += asCalc;
                                    else asDiffMin += asCalc;
                                }

                                if (dt.tipe_produk == 'ts') {
                                    var tsCalc = dt.actual - dt.plan;
                                    if (tsCalc > 0) tsDiffPlus += tsCalc;
                                    else tsDiffMin += tsCalc;
                                }
                            })

                            // Populate datas
                            finalData.tanggal = dataObj.categoryLabel;
                            finalData.categories = [{
                                "label": "FL"
                            }, {
                                "label": "CL"
                            }, {
                                "label": "AS"
                            }, {
                                "label": "TS"
                            }];

                            finalData.surplus = [{
                                "value": flDiffPlus
                            }, {
                                "value": clDiffPlus
                            }, {
                                "value": asDiffPlus
                            }, {
                                "value": tsDiffPlus
                            }];

                            finalData.minus = [{
                                "value": flDiffMin
                            }, {
                                "value": clDiffMin
                            }, {
                                "value": asDiffMin
                            }, {
                                "value": tsDiffMin
                            }];

                            // Render the Extended Chart
                            renderExtChart(finalData);
                        }
                    })
                }
            }
        });

        // Chart #2
        $('#chart-container-2').insertFusionCharts({
            type: 'mscolumn3d',
            width: 1024,
            height: 300,
            dataFormat: 'json',
            dataSource: {
                "chart": {
                    "yAxisName": "Perolehan",
                    "theme": "fusion",
                    "plotFillAlpha": "80",
                    "divLineIsDashed": "1",
                    "divLineDashLen": "1",
                    "divLineGapLen": "1",
                    "showValues": "1"
                },
                "categories": [{
                    "category": data.categories
                }],
                "dataset": [{
                        "seriesname": "Plan",
                        "data": data.plan_2
                    },
                    {
                        "seriesname": "Actual",
                        "data": data.actual_2
                    }
                ]
            },
            "events": {
                "dataPlotClick": function(eventObj, dataObj) {
                    var finalData = {}
                    $.ajax({
                        type: 'POST',
                        url: 'api/postData2.php',
                        dataType: "json",
                        data: {
                            tanggal: moment(dataObj.categoryLabel).format('YYYY-MM-DD')
                        },
                        success: function(res) {
                            var rawObj = res.result;

                            // Find each product's diff
                            var pnDiffPlus = 0,
                                pnDiffMin = 0,
                                rcDiffPlus = 0,
                                rcDiffMin = 0,
                                vnDiffPlus = 0,
                                vnDiffMin = 0;

                            rawObj.forEach(function(dt) {
                                if (dt.tipe_produk == 'pn') {
                                    var pnCalc = dt.actual - dt.plan;
                                    if (pnCalc > 0) pnDiffPlus += pnCalc;
                                    else pnDiffMin += pnCalc;
                                }

                                if (dt.tipe_produk == 'rc') {
                                    var rcCalc = dt.actual - dt.plan;
                                    if (rcCalc > 0) rcDiffPlus += rcCalc;
                                    else rcDiffMin += rcCalc;
                                }

                                if (dt.tipe_produk == 'vn') {
                                    var vnCalc = dt.actual - dt.plan;
                                    if (vnCalc > 0) vnDiffPlus += vnCalc;
                                    else vnDiffMin += vnCalc;
                                }
                            })

                            // Populate datas
                            finalData.tanggal = dataObj.categoryLabel;
                            finalData.categories = [{
                                "label": "PN"
                            }, {
                                "label": "RC"
                            }, {
                                "label": "VN"
                            }];

                            finalData.surplus = [{
                                "value": pnDiffPlus
                            }, {
                                "value": rcDiffPlus
                            }, {
                                "value": vnDiffPlus
                            }];

                            finalData.minus = [{
                                "value": pnDiffMin
                            }, {
                                "value": rcDiffMin
                            }, {
                                "value": vnDiffMin
                            }];

                            // Render the Extended Chart
                            renderExtChart(finalData);
                        }
                    })
                }
            }
        });
    }

    // Render extended chart Fn
    var renderExtChart = function(data) {
        // un-hide buttons
        $('#btn-close, #btn-ws').removeClass('d-none');

        // hide chart #2 container
        $('#chart-2').addClass('d-none');

        // hide chart #1 title and marquee
        $('#title-chart-1, .marquee').addClass('d-none');

        // save respected value on a hidden fields
        $('#hidden-date').val(moment(data.tanggal).format('YYYY-MM-DD'));
        $('#hidden-type').val(data.categories[0].label);

        if (data.categories.length == 3) {
            // exclude the minus mark (-) from PN, RC, VN products
            var tempArr = [];
            data.minus.forEach(function(item) {
                tempArr.push({
                    "value": Math.abs(item.value)
                })
            })
            data.minus = tempArr;
        }

        // main action
        $('#chart-container-1').insertFusionCharts({
            type: 'mscolumn3d',
            width: 1024,
            height: 600,
            dataFormat: 'json',
            dataSource: {
                "chart": {
                    "caption": "Kesesuaian Produksi",
                    "subCaption": "Tanggal " + moment(data.tanggal).format('DD MMMM YYYY'),
                    // "xAxisName": "Produk",
                    "yAxisName": "Perolehan",
                    "theme": "fusion",
                    "plotFillAlpha": "80",
                    "divLineIsDashed": "1",
                    "divLineDashLen": "1",
                    "divLineGapLen": "1",
                    "showValues": "1",
                    "id": 'main-chart'
                },
                "categories": [{
                    "category": data.categories
                }],
                "dataset": [{
                        "seriesname": "Surplus",
                        "data": data.surplus
                    },
                    {
                        "seriesname": "Minus",
                        "data": data.minus
                    }
                ]
            },
            "events": {
                "dataPlotClick": function(eventObj, dataObj) {
                    if (dataObj.categoryLabel == 'FL' || dataObj.categoryLabel == 'CL' || dataObj.categoryLabel == 'AS' || dataObj.categoryLabel == 'TS') {
                        // Call table data API
                        $.ajax({
                            type: 'POST',
                            url: 'api/postDetail.php',
                            dataType: "json",
                            data: {
                                data_type: dataObj.categoryLabel,
                                data_date: $('#hidden-date').val()
                            },
                            success: function(res) {
                                $('#modal-title').html('Data Kesesuaian: ' + dataObj.categoryLabel);
                                $("#table-tgl").html(moment($('#hidden-date').val()).format('DD MMMM YYYY'));

                                // clear the table
                                $("#table-data").html('');

                                if (res.status == 'ok') {
                                    var totPlan = 0,
                                        totAct = 0;
                                    $.each(res.result, function(key, value) {
                                        var diff = value.actual - value.plan;
                                        $("#table-data").append("<tr><td>" + value.gmc + "</td><td>" + value.description + "</td><td>" + value.plan + "</td><td>" + value.actual + "</td><td><strong>" + diff + "</strong></td></tr>");
                                        totPlan += parseInt(value.plan);
                                        totAct += parseInt(value.actual);
                                    })
                                    // append the Qty total
                                    $('#table-total-plan').html(totPlan);
                                    $('#table-total-actual').html(totAct);

                                    // Show the MODAL
                                    $('#modal').modal('show');
                                } else {
                                    $('#modal-error').modal('show');
                                }
                            }
                        })
                    }
                }
            }
        });
    }

    // Call API for Main Chart Fn
    var initiateData = function() {
        // reset components this.state
        $('.marquee, #title-chart-1').removeClass('d-none');

        $.ajax({
            type: 'GET',
            url: 'api/getData.php',
            dataType: "json",
            success: function(response) {
                var finalData = {},
                    dataCategories = [],
                    dataPlan = [],
                    dataActual = [],
                    dataPlan2 = [],
                    dataActual2 = [];

                // summarize data
                if (response.status == 'ok') {
                    // Grouping data by "Tanggal"
                    var rawObj = response.result;

                    // call teh SortData Fn
                    var rawData = sortData(rawObj);

                    // Populating for chart
                    rawData.forEach(function(data) {
                        var dataTgl = {
                            "label": moment(data.category).format('DD MMM YY')
                        }
                        dataCategories.push(dataTgl);

                        var dtPlan = {
                            "value": data.flPlan + data.clPlan + data.asPlan + data.tsPlan
                        }
                        dataPlan.push(dtPlan);

                        var dtAct = {
                            "value": data.flAct + data.clAct + data.asAct + data.tsAct
                        }
                        dataActual.push(dtAct);

                        var dtPlan2 = {
                            "value": data.pnPlan + data.rcPlan + data.vnPlan
                        }
                        dataPlan2.push(dtPlan2);

                        var dtAct2 = {
                            "value": data.pnAct + data.rcAct + data.vnAct
                        }
                        dataActual2.push(dtAct2);
                    })
                }

                // populating data
                finalData = {
                    "categories": dataCategories,
                    "plan": dataPlan,
                    "actual": dataActual,
                    "plan_2": dataPlan2,
                    "actual_2": dataActual2
                };

                // Render main chart
                renderMainChart(finalData);
            }
        });
    }

    // Sort Data Fn (for main chart)
    var sortData = function(rawObj) {
        var group_to_values = rawObj.reduce(function(obj, item) {
            obj[item.tanggal] = obj[item.tanggal] || [];
            obj[item.tanggal].push({
                tipe_produk: item.tipe_produk,
                gmc: item.gmc,
                description: item.description,
                plan: item.plan,
                actual: item.actual
            });
            return obj;
        }, {});

        var groups = Object.keys(group_to_values).map(function(key) {
            return {
                tanggal: key,
                data: group_to_values[key]
            };
        });

        // Then do grouping the result by "Tipe_produk"
        var rawData = [];
        groups.forEach(function(val) {
            var tempObj = {};
            // Iterate the "data" object
            var dtObj = val.data,
                dtFlPlan = 0,
                dtFlAct = 0,
                dtClPlan = 0,
                dtClAct = 0,
                dtAsPlan = 0,
                dtAsAct = 0,
                dtTsPlan = 0,
                dtTsAct = 0,
                dtPnPlan = 0,
                dtPnAct = 0,
                dtVnPlan = 0,
                dtVnAct = 0,
                dtRcPlan = 0,
                dtRcAct = 0;
            dtObj.forEach(function(dt) {
                if (dt.tipe_produk == 'fl') {
                    dtFlPlan += parseInt(dt.plan);
                    dtFlAct += parseInt(dt.actual);
                } else if (dt.tipe_produk == 'cl') {
                    dtClPlan += parseInt(dt.plan);
                    dtClAct += parseInt(dt.actual);
                } else if (dt.tipe_produk == 'as') {
                    dtAsPlan += parseInt(dt.plan);
                    dtAsAct += parseInt(dt.actual);
                } else if (dt.tipe_produk == 'ts') {
                    dtTsPlan += parseInt(dt.plan);
                    dtTsAct += parseInt(dt.actual);
                } else if (dt.tipe_produk == 'pn') {
                    dtPnPlan += parseInt(dt.plan);
                    dtPnAct += parseInt(dt.actual);
                } else if (dt.tipe_produk == 'rc') {
                    dtRcPlan += parseInt(dt.plan);
                    dtRcAct += parseInt(dt.actual);
                } else {
                    dtVnPlan += parseInt(dt.plan);
                    dtVnAct += parseInt(dt.actual);
                }
            });
            tempObj = {
                category: val.tanggal,
                flPlan: dtFlPlan,
                flAct: dtFlAct,
                clPlan: dtClPlan,
                clAct: dtClAct,
                asPlan: dtAsPlan,
                asAct: dtAsAct,
                tsPlan: dtTsPlan,
                tsAct: dtTsAct,
                pnPlan: dtPnPlan,
                pnAct: dtPnAct,
                rcPlan: dtRcPlan,
                rcAct: dtRcAct,
                vnPlan: dtVnPlan,
                vnAct: dtVnAct
            };
            rawData.push(tempObj);
        });

        return rawData;
    }

    // Sort Data Fn (for WS chart)
    var sortWsData = function(rawObj) {
        var group_to_values = rawObj.reduce(function(obj, item) {
            obj[item.produk] = obj[item.produk] || [];
            obj[item.produk].push({
                tanggal: item.tanggal,
                target_persentase: item.target_persentase,
                persentase_shipment: item.persentase_shipment
            });
            return obj;
        }, {});

        var groups = Object.keys(group_to_values).map(function(key) {
            return {
                produk: key,
                data: group_to_values[key]
            };
        });

        return groups;
    }

    // DOM event
    $(document).ready(function() {
        // Render main chart
        initiateData();

        // Button close
        $('#btn-close').click(function() {
            initiateData();
        });

        // Button WS
        $('#btn-ws').click(function() {
            var dType = $('#hidden-type').val();
            var dDate = $('#hidden-date').val();
            var dWeek = moment(dDate).week();

            $.ajax({
                type: 'POST',
                url: 'api/postWs.php',
                dataType: "json",
                data: {
                    data_type: dType,
                    data_week: dWeek
                },
                success: function(response) {
                    // hide WS button
                    $('#btn-ws').addClass('d-none');

                    // Function to get the latest date
                    function getLatestDate(data) {
                        var maxNumb = [];
                        for (var y = 0; y < data.data.length; y++) {
                            maxNumb.push(new Date(data.data[y].tanggal));
                        }
                        var latestDate = moment(new Date(Math.max.apply(null, maxNumb))).format('YYYY-MM-DD');
                        return latestDate;
                    }

                    // Populate dataset
                    var dataSet = [],
                        dataCat = [],
                        tempPlan = [],
                        tempAct = [];
                    var rawData = response.result;
                    var sortedData = sortWsData(rawData);
                    sortedData.forEach(function(dt) {
                        dataCat.push({
                            "label": dt.produk.toUpperCase()
                        });

                        var filteredData = [];
                        var theDate = getLatestDate(dt);
                        dt.data.forEach(function(x) {
                            if (x.tanggal == theDate) filteredData.push(x);
                        });

                        filteredData.forEach(function(y) {
                            tempPlan.push({ "value": y.target_persentase });
                            tempAct.push({ "value": y.persentase_shipment });
                        })
                    });

                    dataSet = [{
                        "seriesname": "Target Persentase",
                        "data": tempPlan
                    }, {
                        "seriesname": "Persentase Shipment",
                        "data": tempAct
                    }];

                    // Render WS chart
                    $('#chart-container-1').insertFusionCharts({
                        type: 'mscolumn3d',
                        width: 1024,
                        height: 600,
                        dataFormat: 'json',
                        dataSource: {
                            "chart": {
                                "caption": "Persentase Produksi Mingguan",
                                "subCaption": "Week " + dWeek,
                                "xAxisName": "Produk",
                                "yAxisName": "Persentase",
                                "theme": "fusion",
                                "plotFillAlpha": "80",
                                "divLineIsDashed": "1",
                                "divLineDashLen": "1",
                                "divLineGapLen": "1",
                                "showValues": "1",
                                "numberSuffix": "%",
                                "id": 'main-chart'
                            },
                            "categories": [{
                                "category": dataCat
                            }],
                            "dataset": dataSet
                        }
                    });
                },
                error: function(err) {
                    alert(JSON.stringify(err));
                }
            })
        });
    });
    </script>
</body>

</html>